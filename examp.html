<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" />
<!-- <style>
#mapid { height: 200px; }
</style> -->
<script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>
<script>

var mymap;
var cur_lon=null;
var cur_lat=null;
var list;
var ip_to_map;
var line_color = 200;

function Onload(){

    mymap = L.map('mapid').setView([51.505, -0.09], 1.1);

	L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
			'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
			'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
		id: 'mapbox.streets'
	}).addTo(mymap);
}

function draw_line(lat,lon,m){
    if (cur_lat == null){
        cur_lat = lat;
    }
    if (cur_lon == null){
        cur_lon = lon;
    }
    L.marker([lat, lon]).addTo(m).openPopup();
        
    //var polygon = L.polygon([
    //[51.509, -0.08],
    //[51.503, -0.06],
    //[51.51, -0.047]
    //]).addTo(mymap);
    
    var polyline = L.polyline([[lat,lon], [cur_lat, cur_lon]],{color : ("#" + String(line_color))}).addTo(m);
    cur_lat = lat;
    cur_lon = lon;
    line_color += 60;
}

function get_ips(xml){
    var xmlDoc = xml.responseXML;
    ip_to_map = [];//[document.getElementById("ip_or_dns").value];
    //alert("in func");
    for(var i=0; i<xmlDoc.getElementsByTagName("ipAddr").length; i++ ){
        ip_to_map.push(xmlDoc.getElementsByTagName("ipAddr")[i].childNodes[0].nodeValue);
        
        //ip_to_map.push(document.getElementsByTagName("ipAddr")[i].getAttribute("adrs"));
    }
    //return ip_to_map;
}
    

function send_ip(){
    var xml = new XMLHttpRequest(),
    
        method = "GET",
        url = "ip_or_dns?",
        address = document.getElementById("ip_or_dns").value;
        //alert(address);

    xml.open(method,url+address, true);
    xml.onreadystatechange = function () {
            if(xml.readyState == XMLHttpRequest.DONE && xml.status == 200) {
                
                //alert(xml.responseText);
                
                get_ips(xml);
                
                //alert("iplist:");
                //alert(ip_to_map);
                
                request_coordinates();
               
            }
            
        };

    xml.send();
    return false;
}

function request_coordinates() {
    //alert("A")
    var xml = new XMLHttpRequest(),
        method = "GET",
        url = "http://ip-api.com/xml/",
        address = ip_to_map.shift();
        
        
    
//for(var i=0; i<ip_list.length; i++){  

    //alert('address');
    //alert(address);        
    
    //var xml = new XMLHttpRequest()
    //address=String(address);
    xml.open(method,url+address, true);
    //alert("helloooo");

    
    xml.onreadystatechange = function (){
            //alert(xml.readyState);
            //alert(xml.status);
            if(xml.readyState === XMLHttpRequest.DONE && xml.status === 200) {
                //alert( "result555555555   "+xml.responseText);
                myFunction(this);

            }
        };

    xml.send();
    //address = String(ip_list[i]);
//}
    return false;
}

function isSuccess(xml){
    var xmlDoc = xml.responseXML;
    xml_status = xmlDoc.getElementsByTagName("status")[0].childNodes[0].nodeValue;
    //alert(xml_status);
    if (xml_status==='success'){
        return true;
    }
    return false;
}

function myFunction(xml) {
    
    var xmlDoc = xml.responseXML;
    if ((xmlDoc != null) && isSuccess(xml)) {
        
        lat = xmlDoc.getElementsByTagName("lat")[0].childNodes[0].nodeValue;
        lon = xmlDoc.getElementsByTagName("lon")[0].childNodes[0].nodeValue;
        document.getElementById("demo").innerHTML = lat;
        document.getElementById("demo2").innerHTML = lon;
        draw_line(lat,lon,mymap);

    }
    if (ip_to_map.length > 0){
        request_coordinates();
    }
}


</script>
</link>
</head>

<body onload="Onload()"> 
<div id="mapid" style="width: 600px; height: 400px;"></div>

<p id="demo"></p>
<p id="demo2"></p>

<form onsubmit='return send_ip()' >
<p>
Enter an ip address or dns: 
</p>
<input  id="ip_or_dns"><br>
<input type="submit" value="Submit" >
hello

</form>
</body>
</html>
