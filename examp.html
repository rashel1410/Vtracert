<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" />
<!-- <style>
#mapid { height: 200px; }
</style> -->
<script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>
<script>

var mymap;
var cur_lon=null;
var cur_lat=null;
var list;
var ip_to_map;
var line_color = 200;

function Onload(){

    mymap = L.map('mapid').setView([51.505, -0.09], 1.1);

	L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
			'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
			'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
		id: 'mapbox.streets'
	}).addTo(mymap);
} 

function draw_line(lat,lon,m){

    if (cur_lat == null){
        cur_lat = lat;
    }
    if (cur_lon == null){
        cur_lon = lon;
    }
    L.marker([lat, lon]).addTo(m).openPopup();
    var polyline = L.polyline([[lat,lon], [cur_lat, cur_lon]],{color : ("#" + String(line_color))}).addTo(m);
    cur_lat = lat;
    cur_lon = lon;
    line_color += 60;
}

function get_ips(xml){

    var xmlDoc = xml.responseXML;
    ip_to_map = [];

    for(var i=0; i<xmlDoc.getElementsByTagName("ipAddr").length; i++ ){
        ip_to_map.push(xmlDoc.getElementsByTagName("ipAddr")[i].childNodes[0].nodeValue);
    }
}


function send_ip(){

    var xml = new XMLHttpRequest(),
    
        method = "GET",
        url = "ip_or_dns?",
        address = document.getElementById("ip_or_dns").value;

    xml.open(method,url+address, true);
    xml.onreadystatechange = function () {
            if(xml.readyState == XMLHttpRequest.DONE && xml.status == 200) {
                
                get_ips(xml);
                request_coordinates();
               
            }
            
        };

    xml.send();
    return false;
}

function request_coordinates() {

    var xml = new XMLHttpRequest(),
        method = "GET",
        url = "http://ip-api.com/xml/",
        address = ip_to_map.shift();
        
    xml.open(method,url+address, true);
    xml.onreadystatechange = function (){

            if(xml.readyState === XMLHttpRequest.DONE && xml.status === 200) {
                myFunction(this);

            }
        };
    xml.send();
    return false;
}

function isSuccess(xml){

    var xmlDoc = xml.responseXML;
    xml_status = xmlDoc.getElementsByTagName("status")[0].childNodes[0].nodeValue;

    if (xml_status==='success'){
        return true;
    }
    return false;
}

function myFunction(xml) {
   
    var xmlDoc = xml.responseXML;
    if ((xmlDoc != null) && isSuccess(xml)) {
        
        lat = xmlDoc.getElementsByTagName("lat")[0].childNodes[0].nodeValue;
        lon = xmlDoc.getElementsByTagName("lon")[0].childNodes[0].nodeValue;
        document.getElementById("demo").innerHTML = lat;
        document.getElementById("demo2").innerHTML = lon;
        draw_line(lat,lon,mymap);

    }
    if (ip_to_map.length > 0){
        request_coordinates();
    }
}


</script>
</link>
</head>

<body onload="Onload()"> 
<div id="mapid" style="width: 600px; height: 400px;"></div>

<p id="demo"></p>
<p id="demo2"></p>

<form onsubmit='return send_ip()' >
<p>
Enter an ip address or dns: 
</p>
<input  id="ip_or_dns"><br>
<input type="submit" value="Submit" >


</form>
</body>
</html>
