<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" />
<!-- <style>
#mapid { height: 300px; }
</style> -->
<script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>
<script>

var mymap; // the map object
var cur_lon=null; // current latitude
var cur_lat=null; // current longtitude
var ip_to_map; // ip address given by to user
var state; // status
var line_color = 500; // route line initial color
var ttl = 1; // time to live

// Onload function that is called when the web browser first loads
// Creates a map on the screen
function Onload(){
    mymap = L.map('mapid').setView([51.505, -0.09], 1.1);
	L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
			'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
			'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
		id: 'mapbox.streets'
	}).addTo(mymap);
} 

// Puts a dot on the map and draws a line connecting it with the last dot
function draw_line(lat,lon,m){
    if (cur_lat == null){
        cur_lat = lat;
    }
    if (cur_lon == null){
        cur_lon = lon;
    }
    L.marker([lat, lon]).addTo(m).openPopup();
    var polyline = L.polyline([[lat,lon], [cur_lat, cur_lon]],{color : ("#" + String(line_color))}).addTo(m);
    cur_lat = lat;
    cur_lon = lon;
    line_color += 60;
}

// Reset the arguments of status and address from a given xml
function get_ip(xml){
    var xmlDoc = xml.responseXML;
    ip_to_map = xmlDoc.getElementsByTagName("ipAddr")[0].childNodes[0].nodeValue;
    state = xmlDoc.getElementsByTagName("status")[0].childNodes[0].nodeValue;
}

// Sends request to the server with the dest. address and ttl value
// calls the function request_coordinates
function send_ip(){
    var xml = new XMLHttpRequest(),
    
        method = "GET",
        url = "trace?",
        first_param = "ip_or_dns=",
        first_value = document.getElementById("ip_or_dns").value,
        sec_param = "&ttl=",
        sec_value = String(ttl),
        params = first_param+first_value+sec_param+sec_value;
        
    xml.open(method,url+params, true);
    xml.onreadystatechange = function () {
            if(xml.readyState == XMLHttpRequest.DONE && xml.status == 200) {
                get_ip(xml);
                if (state == 'TIMEOUT'){
                    document.getElementById("demo").innerHTML = 'Request timed out';
                    send_ip();
                }
                else{
                    request_coordinates();
                }
            }
        };
    
    ttl++;
    xml.send();
    return false;
}

// Sends request to geo ip service 
// gets back xml respond
function request_coordinates() {
    var xml = new XMLHttpRequest(),
        method = "GET",
        url = "http://ip-api.com/xml/";
        address = ip_to_map;
    xml.open(method,url+address, true);
    xml.onreadystatechange = function (){
            if(xml.readyState === XMLHttpRequest.DONE && xml.status === 200) {
                myFunction(this);
                
            }
        };
    xml.send();
    return false;
}

// true if status of geo ip respond is success
function isSuccess(xml){
    var xmlDoc = xml.responseXML;
    xml_status = xmlDoc.getElementsByTagName("status")[0].childNodes[0].nodeValue;
    if (xml_status==='success'){
        return true;
    }
    return false;
}

// gets the location out of the given xml response, if status is not REACH, keep tracing.
function myFunction(xml) {
    var xmlDoc = xml.responseXML;
    if ((xmlDoc != null) && isSuccess(xml)) {
            lat = xmlDoc.getElementsByTagName("lat")[0].childNodes[0].nodeValue;
            lon = xmlDoc.getElementsByTagName("lon")[0].childNodes[0].nodeValue;
            draw_line(lat,lon,mymap);
    }
    if (state == 'REACH'){
        alert('The Packet reached the destination successfully!');
    }
    else{
        send_ip();
    }

}
</script>
</link>
</head>

<body onload="Onload()"> 
<div id="mapid" style="width: 800px; height: 550px;"></div>

<form onsubmit='return send_ip()' >
<p>
Enter an ip address or dns: 
</p>
<input  id="ip_or_dns"><br>
<input type="submit" value="Trace!" >


</form>
</body>
</html>